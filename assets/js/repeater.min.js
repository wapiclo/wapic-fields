(function($){
  'use strict';

  function getRowCount($wrap){
    return $wrap.find('.wcf-repeater-row:not(.wcf-repeater-template)').length;
  }

  function replaceIndexAttrs($el, idx){
    $el.find('[name]').each(function(){
      var name = $(this).attr('name');
      if (!name) return;
      $(this).attr('name', name.replace('[__INDEX__]', '[' + idx + ']'));
    });
    $el.find('[id]').each(function(){
      var id = $(this).attr('id');
      if (id) $(this).attr('id', id.replace('__INDEX__', String(idx)));
    });
    $el.find('[aria-controls]').each(function(){
      var ac = $(this).attr('aria-controls');
      if (ac) $(this).attr('aria-controls', ac.replace('__INDEX__', String(idx)));
    });
    $el.find('[for]').each(function(){
      var fr = $(this).attr('for');
      if (fr) $(this).attr('for', fr.replace('__INDEX__', String(idx)));
    });
  }

  function updateRowTitle($row, titleField){
    if (!titleField) return;
    var $input = $row.find('.wcf-repeater-field[data-subfield-id="'+titleField+'"]').find('input, select, textarea').first();
    var val = ($input.val() || '').toString().trim();
    $row.find('.wcf-repeater-row-title').text(val !== '' ? val : 'Item');
  }

  function setOpen($row, open){
    var $btn = $row.find('> .wcf-repeater-row-header .wcf-repeater-accordion-toggle');
    var $body = $row.find('> .wcf-repeater-row-body');
    if(open){
      $btn.attr('aria-expanded','true');
      $body.stop(true, true).slideDown(150);
      $btn.text('▲');
    } else {
      $btn.attr('aria-expanded','false');
      $body.stop(true, true).slideUp(150);
      $btn.text('▼');
    }
  }

  function bindRowEvents($wrap, $row, titleField){
    if (titleField) {
      $row.on('input change', '.wcf-repeater-field[data-subfield-id="'+titleField+'"] input, .wcf-repeater-field[data-subfield-id="'+titleField+'"] select, .wcf-repeater-field[data-subfield-id="'+titleField+'"] textarea', function(){
        updateRowTitle($row, titleField);
      });
      updateRowTitle($row, titleField);
    }
    $row.on('click', '.wcf-repeater-accordion-toggle', function(e){
      e.preventDefault();
      var $btn = $(this);
      var expanded = $btn.attr('aria-expanded') === 'true';
      setOpen($row, !expanded);
    });
    // Header click no longer toggles; arrow button only
    $row.on('click', '.wcf-repeater-remove', function(e){
      e.preventDefault();
      $row.remove();
    });

    // Initialize field plugins for this row
    initRowPlugins($row);

    // Media select/clear handlers
    $row.off('click.wcfMedia').on('click.wcfMedia', '.wcf-media-select', function(e){
      e.preventDefault();
      if (!(window.wp && wp.media)) return;
      var type = $(this).data('media-type') || 'image';
      var targetSel = $(this).data('target');
      var $target = $row.find(targetSel);
      if (!$target.length) return;

      var frame = wp.media({
        title: type === 'gallery' ? 'Select Images' : 'Select Image',
        library: { type: 'image' },
        multiple: type === 'gallery'
      });

      frame.on('select', function(){
        if (type === 'gallery') {
          var ids = frame.state().get('selection').map(function(att){ return att.id; });
          $target.val(ids.join(',')).trigger('change');
        } else {
          var att = frame.state().get('selection').first();
          if (att) {
            var data = att.toJSON();
            $target.val(data.url || '').trigger('change');
          }
        }
      });

      frame.open();
    }).on('click.wcfMedia', '.wcf-media-clear', function(e){
      e.preventDefault();
      var targetSel = $(this).data('target');
      var $target = $row.find(targetSel);
      if ($target.length) {
        $target.val('').trigger('change');
      }
    });
  }

  $(document).ready(function(){
    $('.wcf-repeater').each(function(){
      var $wrap = $(this);
      var max   = parseInt($wrap.data('max'), 10) || 0;
      var titleField = ($wrap.data('title-field') || '').toString();

      // Make rows sortable
      if ($.fn.sortable) {
        $wrap.sortable({
          items: '> .wcf-repeater-row:not(.wcf-repeater-template)',
          handle: '.wcf-repeater-drag-handle',
          axis: 'y',
          placeholder: 'wcf-repeater-placeholder',
          update: function(){ renumberRows($wrap); }
        });
      }

      $wrap.find('.wcf-repeater-row:not(.wcf-repeater-template)').each(function(){
        var $row = $(this);
        bindRowEvents($wrap, $row, titleField);
        // ensure collapsed initially via helper (sets icon too)
        setOpen($row, false);
      });

      $wrap.on('click', '.wcf-repeater-add', function(e){
        e.preventDefault();
        var count = getRowCount($wrap);
        if (max > 0 && count >= max) return;

        var $tpl = $wrap.find('.wcf-repeater-template').first().clone(true, true);
        $tpl.removeClass('wcf-repeater-template').show();

        var idx = count;
        replaceIndexAttrs($tpl, idx);

        // reset values
        $tpl.find('input[type="text"], input[type="email"], input[type="url"], input[type="number"], input[type="hidden"], input[type="date"]').val('');
        $tpl.find('textarea').val('');
        $tpl.find('select').each(function(){
          var $s = $(this);
          if ($s.prop('multiple')) $s.val([]);
          else $s.val($s.find('option').first().val() || '');
        });

        // enable inputs on the cloned row (template had disabled)
        $tpl.find('input, select, textarea').prop('disabled', false).removeAttr('disabled');

        $wrap.find('.wcf-repeater-actions').before($tpl);

        bindRowEvents($wrap, $tpl, titleField);
        // ensure expanded
        setOpen($tpl, true);

        // Initialize WP editor for editor textareas if available
        if (window.wp && wp.editor && typeof wp.editor.initialize === 'function') {
          $tpl.find('textarea.wcf-field-editor').each(function(){
            var id = $(this).attr('id');
            if (id) {
              try { wp.editor.initialize(id, { tinymce: true, quicktags: true }); } catch(e) {}
            }
          });
        }
      });
    });
  });

  function initRowPlugins($row){
    // Select2
    if ($.fn.select2) {
      $row.find('select.wcf-field-select2').each(function(){
        var $s = $(this);
        var width = $s.data('width') || '100%';
        var placeholder = $s.data('placeholder') || '';
        var allowClear = ($s.data('allow-clear') || '').toString() === 'true';
        if ($s.data('select2')) { $s.select2('destroy'); }
        $s.select2({ width: width, placeholder: placeholder, allowClear: allowClear });
        $s.trigger('change');
      });
    }
    // Color Picker
    if ($.fn.wpColorPicker) {
      $row.find('input.wcf-field-color').each(function(){
        var $c = $(this);
        if (!$c.hasClass('wp-color-picker')) {
          try { $c.wpColorPicker(); } catch(e){}
        }
      });
    }
    // Datepicker
    if ($.fn.datepicker) {
      $row.find('input.wcf-field-date').each(function(){
        var $d = $(this);
        try { $d.datepicker(); } catch(e){}
      });
    }
  }

  function renumberRows($wrap){
    $wrap.find('> .wcf-repeater-row:not(.wcf-repeater-template)').each(function(i){
      var $row = $(this);
      $row.attr('data-index', i);
      // ids and controls
      $row.find('[id]').each(function(){
        var id = $(this).attr('id');
        if (!id) return;
        id = id.replace(/_(?:__INDEX__|\d+)_/, '_' + i + '_');
        $(this).attr('id', id);
      });
      $row.find('[aria-controls]').each(function(){
        var ac = $(this).attr('aria-controls');
        if (ac) $(this).attr('aria-controls', ac.replace(/_(?:__INDEX__|\d+)_/, '_' + i + '_'));
      });
      $row.find('[for]').each(function(){
        var fr = $(this).attr('for');
        if (fr) $(this).attr('for', fr.replace(/_(?:__INDEX__|\d+)_/, '_' + i + '_'));
      });
      // names
      $row.find('[name]').each(function(){
        var name = $(this).attr('name');
        if (!name) return;
        name = name.replace(/\[[0-9]+\]/, '[' + i + ']');
        $(this).attr('name', name);
      });
    });
  }
})(jQuery);
